pipeline {
    agent any
	tools {
		nodejs 'nodejs 22.3.0' // jenkins nodejs name
		}
	// npm install -g newman-reporter-allure
	// npm install -g allure-commandline
    parameters {
        string(name: 'url', defaultValue: 'https://api.cloudinary.com/v1_1/dh9uchtpo/upload', description: 'cloudinary url')
    }

    stages {
        stage('Run Newman API Tests') {
            def nodeInstalled = sh(script: 'node --version', returnStatus: true) == 0
            steps {
                script {
                    sh '''
                        . ~/.nvm/nvm.sh
                        npm install 16
                        nvm use 16
                        npm install newman
                        newman --version
                        npm install -g newman-reporter-allure
                        rm -rf allure-results
                        newman run collection.json --insecure -r allure --reporter-allure-export allure-results
                    '''
                }
            }
        }
        }

def publishAllureResults(String filepath) {
allure([
        includeProperties: false,
        jdk: '',
        properties: [],
        reportBuildPolicy: 'ALWAYS',
        results: [[path: filepath]]
            ])
        }

	// stage('Delete reports'){
    //         steps{
    //             script {
    //             sh """
	// 				rm -rf allure-results
    //             """
    //             }
    //         }
    //     }
}